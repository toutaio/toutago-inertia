# Release Process

This document describes the automated release process for toutago-inertia.

## Overview

Releases are automated via GitHub Actions when a version tag is pushed. The workflow:

1. **Validates** the release by running all tests and linters
2. **Creates** a GitHub Release with changelog notes
3. **Publishes** NPM packages to the npm registry

## Prerequisites

### NPM Authentication

To publish packages to npm, you need to configure the `NPM_TOKEN` secret:

1. Create an NPM access token at https://www.npmjs.com/settings/YOUR_USERNAME/tokens
   - Select "Automation" token type for CI/CD
   - Copy the token

2. Add the token to GitHub repository secrets:
   - Go to repository Settings → Secrets and variables → Actions
   - Click "New repository secret"
   - Name: `NPM_TOKEN`
   - Value: (paste your npm token)
   - Click "Add secret"

## Creating a Release

### 1. Update Version Numbers

First, update the version in the relevant files:

```bash
# Example for version 0.3.0
VERSION="0.3.0"

# Update Go module (no version file needed - uses git tags)

# Update NPM packages
cd packages/inertia-vue
npm version $VERSION --no-git-tag-version
cd ../..
```

### 2. Update CHANGELOG.md

Add a new section for the release in `CHANGELOG.md`:

```markdown
## [0.3.0] - 2026-01-06

### Added
- New feature X
- New feature Y

### Changed
- Improvement Z

### Fixed
- Bug fix A
```

Make sure to:
- Use the format `## [VERSION] - YYYY-MM-DD`
- Follow [Keep a Changelog](https://keepachangelog.com/) format
- List all notable changes since the last release

### 3. Commit Changes

```bash
git add .
git commit -m "Prepare release v$VERSION"
git push origin main
```

### 4. Create and Push Tag

```bash
# Create annotated tag
git tag -a v$VERSION -m "Release v$VERSION"

# Push tag to trigger release workflow
git push origin v$VERSION
```

**Important:** The tag must follow the format `v*.*.*` (e.g., `v0.3.0`)

## What Happens Next

Once you push the tag, the GitHub Actions workflow will:

### 1. Validate Stage
- Verify tag format
- Run Go tests with race detector
- Run golangci-lint
- Build Go package
- Install NPM dependencies
- Run NPM tests
- Build NPM packages

If any of these fail, the release is aborted.

### 2. GitHub Release Stage
- Extract changelog for the version
- Create GitHub Release with:
  - Tag name (e.g., `v0.3.0`)
  - Release notes from CHANGELOG.md
  - Attached assets (auto-generated by GitHub)

### 3. NPM Publish Stage
- Update package.json versions to match tag
- Publish all non-private packages to npm registry
  - `@toutaio/inertia-vue`
  - (future packages...)

### 4. Notification
- Reports success/failure status
- Shows which stages completed

## Monitoring the Release

1. Go to the [Actions tab](https://github.com/toutaio/toutago-inertia/actions)
2. Find the "Release" workflow run for your tag
3. Monitor the progress of each job
4. Check for any errors

## Verifying the Release

After the workflow completes:

### GitHub Release
1. Go to [Releases](https://github.com/toutaio/toutago-inertia/releases)
2. Verify your release is listed
3. Check that changelog notes are correct

### NPM Packages
1. Check npm package page: https://www.npmjs.com/package/@toutaio/inertia-vue
2. Verify version is updated
3. Test installation:
   ```bash
   npm install @toutaio/inertia-vue@$VERSION
   ```

### Go Module
1. Verify the tag appears in pkg.go.dev (may take a few minutes)
2. Test installation:
   ```bash
   go get github.com/toutaio/toutago-inertia@v$VERSION
   ```

## Troubleshooting

### Release Workflow Failed

Check the workflow logs to identify which stage failed:

- **Validate stage**: Fix tests, linting, or build issues, then create a new patch version
- **GitHub Release**: Check changelog format or GitHub token permissions
- **NPM Publish**: Verify NPM_TOKEN secret and package.json configuration

### Need to Re-release

If you need to fix a failed release:

1. **Delete the tag locally and remotely:**
   ```bash
   git tag -d v$VERSION
   git push origin :refs/tags/v$VERSION
   ```

2. **Fix the issues** in your code

3. **Create a new patch version:**
   ```bash
   # e.g., if v0.3.0 failed, create v0.3.1
   NEW_VERSION="0.3.1"
   ```

4. **Follow the release process again** with the new version

### NPM Package Already Published

NPM doesn't allow overwriting published versions. If you published a broken version:

1. **Don't delete from npm** (breaks existing users)
2. **Publish a patch version** with the fix (e.g., v0.3.1)
3. **Deprecate the broken version:**
   ```bash
   npm deprecate @toutaio/inertia-vue@0.3.0 "Broken release, use 0.3.1 instead"
   ```

## Versioning Strategy

We follow [Semantic Versioning](https://semver.org/):

- **Major (v1.0.0 → v2.0.0)**: Breaking API changes
- **Minor (v0.1.0 → v0.2.0)**: New features, backward compatible
- **Patch (v0.1.0 → v0.1.1)**: Bug fixes, backward compatible

### Pre-1.0 Releases

During pre-1.0 development (v0.x.x):
- Minor version may include breaking changes
- Patch version for bug fixes only
- Document breaking changes clearly in CHANGELOG

## Release Checklist

Before creating a release:

- [ ] All tests passing locally
- [ ] CHANGELOG.md updated with version and date
- [ ] Version bumped in package.json files
- [ ] Breaking changes documented
- [ ] Migration guide updated (if breaking changes)
- [ ] Examples updated to use new features
- [ ] README updated if needed
- [ ] Committed and pushed to main
- [ ] NPM_TOKEN secret configured (first time only)

After pushing tag:

- [ ] GitHub Actions workflow completed successfully
- [ ] GitHub Release created with correct notes
- [ ] NPM packages published and accessible
- [ ] Go module indexed on pkg.go.dev
- [ ] Announcement posted (if major/minor release)

## Emergency Rollback

If a critical bug is discovered after release:

1. **Publish a hotfix immediately:**
   ```bash
   # Fix the bug
   git commit -m "Fix critical bug in v$VERSION"
   
   # Create patch version
   git tag -a v0.3.1 -m "Hotfix for v0.3.0"
   git push origin v0.3.1
   ```

2. **Deprecate the broken version:**
   ```bash
   npm deprecate @toutaio/inertia-vue@$VERSION "Critical bug, use 0.3.1"
   ```

3. **Update GitHub Release** with warning notice

4. **Announce the hotfix** to users

## Questions?

- Check the [GitHub Actions logs](https://github.com/toutaio/toutago-inertia/actions)
- Review the [release workflow](.github/workflows/release.yml)
- Open an issue for release-related problems
