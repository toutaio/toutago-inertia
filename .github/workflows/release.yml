name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Verify tag format
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Invalid tag format: $TAG"
          echo "Expected format: v*.*.* (e.g., v1.0.0)"
          exit 1
        fi
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "VERSION=${TAG#v}" >> $GITHUB_ENV

    - name: Download Go dependencies
      run: go mod download

    - name: Run Go tests
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

    - name: Run Go linter
      uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m

    - name: Build Go package
      run: go build -v ./...

    - name: Install NPM dependencies
      run: npm install

    - name: Run NPM tests
      run: npm test --workspaces --if-present

    - name: Build NPM packages
      run: npm run build --workspaces --if-present

  release-go:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Extract changelog for version
      id: changelog
      run: |
        TAG=${{ env.TAG }}
        VERSION=${{ env.VERSION }}
        
        # Extract changelog section for this version
        if [ -f CHANGELOG.md ]; then
          CHANGELOG=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          if [ -z "$CHANGELOG" ]; then
            # Fallback: try with brackets
            CHANGELOG=$(awk "/^## ${VERSION}[^0-9]/{flag=1; next} /^## [0-9]/{flag=0} flag" CHANGELOG.md)
          fi
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release ${TAG}"
          fi
        else
          CHANGELOG="Release ${TAG}"
        fi
        
        # Save to file for multiline support
        echo "$CHANGELOG" > /tmp/changelog.txt
        echo "CHANGELOG_FILE=/tmp/changelog.txt" >> $GITHUB_ENV

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        name: ${{ env.TAG }}
        body_path: ${{ env.CHANGELOG_FILE }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-npm:
    name: Publish NPM Packages
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'

    - name: Extract version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Install dependencies
      run: npm install

    - name: Build packages
      run: npm run build --workspaces --if-present

    - name: Update package versions
      run: |
        VERSION=${{ env.VERSION }}
        for pkg in packages/*/package.json; do
          if [ -f "$pkg" ]; then
            # Update version in package.json
            npm version $VERSION --no-git-tag-version --prefix $(dirname $pkg)
          fi
        done

    - name: Publish to NPM
      run: |
        for pkg in packages/*; do
          if [ -d "$pkg" ] && [ -f "$pkg/package.json" ]; then
            # Check if package is private
            PRIVATE=$(node -p "require('./$pkg/package.json').private || false")
            if [ "$PRIVATE" = "false" ]; then
              echo "Publishing $pkg..."
              cd $pkg
              npm publish --access public
              cd ../..
            else
              echo "Skipping private package: $pkg"
            fi
          fi
        done
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [release-go, release-npm]
    if: always()
    
    steps:
    - name: Check status
      run: |
        if [ "${{ needs.release-go.result }}" = "success" ] && [ "${{ needs.release-npm.result }}" = "success" ]; then
          echo "✅ Release completed successfully!"
          echo "TAG: ${GITHUB_REF#refs/tags/}"
        else
          echo "❌ Release failed!"
          echo "Go Release: ${{ needs.release-go.result }}"
          echo "NPM Release: ${{ needs.release-npm.result }}"
          exit 1
        fi
